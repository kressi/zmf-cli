language: python

python:
  - '3.8.6'
  - '3.9-dev'

jobs:
  include:
    - &stage_deploy
      stage: deploy test
      if: NOT branch = main
      install:
        - pip install --upgrade pip
        - pip install twine pep517
      before-script:
        - python -m pep517.check .
        - python -m pep517.build .
        - twine check dist/*
      script:
        - twine upload --skip-existing --repository testpypi dist/*

    - <<: *stage_deploy
      stage: deploy prod
      if: branch = main
      script:
        - twine upload dist/*

install:
  - pip install --upgrade pip
  - pip install .[tests]
  - pip install coveralls

script:
  - flake8
  - black --diff .
  - black --check .
  - pytest --cov=zmfcli
  - coveralls
